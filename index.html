<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  const inputEl  = document.getElementById('messageInput');
  const sendBtn  = document.getElementById('sendBtn');
  const outputEl = document.getElementById('replyOutput');

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) {
      outputEl.textContent = 'Vänligen skriv något innan du skickar.';
      return;
    }
    outputEl.textContent = 'Skickar…';

    try {
      const res = await fetch('/api/anthropic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });

      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); }
      catch {
        outputEl.textContent = `Ogiltigt JSON från servern: ${raw}`;
        return;
      }

      if (!res.ok) {
        // Visa error, details och eventuell trace
        let msg = `Fel ${res.status}: ${data.error || res.statusText}`;
        if (data.details) msg += `\nDetaljer: ${data.details}`;
        if (data.trace)   msg += `\nTrace:\n${data.trace.join('\n')}`;
        outputEl.textContent = msg;
        return;
      }

      if (data.error) {
        outputEl.textContent = `Error: ${data.error}` +
          (data.details ? `\nDetaljer: ${data.details}` : '') +
          (data.trace   ? `\nTrace:\n${data.trace.join('\n')}` : '');
        return;
      }

      outputEl.textContent = data.reply;
    }
    catch (err) {
      console.error(err);
      outputEl.textContent = 'Fel: ' + err.message;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
});
</script>
