<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  const inputEl  = document.getElementById('messageInput');
  const sendBtn  = document.getElementById('sendBtn');
  const outputEl = document.getElementById('replyOutput');

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) {
      outputEl.textContent = 'Vänligen skriv något innan du skickar.';
      return;
    }
    outputEl.textContent = 'Skickar…';

    try {
      const res = await fetch('/api/anthropic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });

      const raw = await res.text();
      let data;
      try {
        data = JSON.parse(raw);
      } catch {
        throw new Error(`Ogiltigt JSON från servern:\n${raw}`);
      }

      if (!res.ok) {
        let msg = `Fel ${res.status}: ${data.error || res.statusText}`;
        if (data.details) msg += `\nDetaljer: ${data.details}`;
        if (data.trace)   msg += `\nStack:\n${data.trace.join('\n')}`;
        throw new Error(msg);
      }

      if (data.error) {
        let msg = `Error: ${data.error}`;
        if (data.details) msg += `\nDetaljer: ${data.details}`;
        if (data.trace)   msg += `\nStack:\n${data.trace.join('\n')}`;
        throw new Error(msg);
      }

      outputEl.textContent = data.reply;
    }
    catch (err) {
      console.error(err);
      outputEl.textContent = err.message;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
});
</script>
