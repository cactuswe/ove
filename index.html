<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat med Ove (Claude 3)</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 700px; }
    .hidden { display: none; }
    input, textarea, button { font-size: 1rem; margin-top: 0.5rem; width: 100%; }
    #chatWindow {
      border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto;
      background: #f9f9f9; margin-bottom: 1rem;
    }
    .message.user      { text-align: right;   color: #007bff; }
    .message.assistant { text-align: left;    color: #333;    }
    .indicator {
      padding: 0 0.6em; border-radius: 1em; font-size: 0.9em; vertical-align: middle;
    }
    .indicator.offline { background: #ccc;    color: #666; }
    .indicator.online  { background: #4caf50; color: #fff; }
  </style>
</head>
<body>
  <h1>Chat med Ove</h1>

  <!-- Auth UI -->
  <div id="authUI">
    <h2>Registera nytt konto</h2>
    <input id="regDisplayName" type="text"     placeholder="Visningsnamn" />
    <input id="regEmail"       type="email"    placeholder="E-post" />
    <input id="regPassword"    type="password" placeholder="Lösenord" />
    <button id="btnRegister">Registera</button>
    <hr>
    <h2>Logga in</h2>
    <input id="loginId"       type="text"     placeholder="Visningsnamn eller e-post" />
    <input id="loginPassword" type="password" placeholder="Lösenord" />
    <button id="btnLogin">Logga in</button>
  </div>

  <!-- Chat UI -->
  <div id="chatUI" class="hidden">
    <p>
      Inloggad som <strong><span id="userName"></span></strong>
      <button id="btnLogout" style="width:auto; display:inline-block; margin-left:1rem;">
        Logga ut
      </button>
    </p>
    <div id="chatWindow"></div>
    <div style="margin-bottom:0.5rem;">
      <strong>Ove:</strong>
      <span id="oveIndicator" class="indicator offline">Offline</span>
    </div>
    <textarea id="messageInput" rows="3" placeholder="Skriv ditt meddelande…"></textarea>
    <button id="sendBtn">Skicka</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      collection,
      addDoc,
      query,
      orderBy,
      where,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Initiera Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBRMtuyLiyRfWwq1p3e_dSE83Z7sBYJM3I",
      authDomain: "ove-ai.firebaseapp.com",
      projectId: "ove-ai",
      storageBucket: "ove-ai.firebasestorage.app",
      messagingSenderId: "200723689801",
      appId: "1:200723689801:web:5dbedb16f582048081ea98",
      measurementId: "G-PEZM6B3N58"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI-element
    const authUI       = document.getElementById("authUI");
    const chatUI       = document.getElementById("chatUI");
    const regDn        = document.getElementById("regDisplayName");
    const regEm        = document.getElementById("regEmail");
    const regPw        = document.getElementById("regPassword");
    const btnReg       = document.getElementById("btnRegister");
    const loginId      = document.getElementById("loginId");
    const loginPw      = document.getElementById("loginPassword");
    const btnLogin     = document.getElementById("btnLogin");
    const btnLogout    = document.getElementById("btnLogout");
    const userNameEl   = document.getElementById("userName");
    const chatWindow   = document.getElementById("chatWindow");
    const messageIn    = document.getElementById("messageInput");
    const sendBtn      = document.getElementById("sendBtn");
    const oveIndicator = document.getElementById("oveIndicator");

    let chatUnsub     = null;
    let presenceUnsub = null;
    let presenceRef   = null;
    let isOveActive   = false;

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.classList.add("message", role);
      div.textContent = text;
      chatWindow.append(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- Registrera nytt konto ---
    btnReg.addEventListener("click", async () => {
      try {
        const cred = await createUserWithEmailAndPassword(auth, regEm.value, regPw.value);
        await updateProfile(cred.user, { displayName: regDn.value });
        await setDoc(doc(db, "users", cred.user.uid), {
          displayName: regDn.value,
          email: cred.user.email
        });
      } catch (e) {
        alert("Registreringsfel: " + e.message);
      }
    });

    // --- Logga in (e-post eller visningsnamn) ---
    btnLogin.addEventListener("click", async () => {
      try {
        let email = loginId.value.trim();
        if (email && !/@/.test(email)) {
          const q    = query(collection(db, "users"), where("displayName", "==", email));
          const snap = await (await getDoc(q)).data();
          if (!snap) throw new Error("Ingen användare med det visningsnamnet");
          email = snap.email;
        }
        await signInWithEmailAndPassword(auth, email, loginPw.value);
      } catch (e) {
        alert("Login-fel: " + e.message);
      }
    });

    // --- Logga ut ---
    btnLogout.addEventListener("click", () => signOut(auth));

    // --- Auth-status ändras ---
    onAuthStateChanged(auth, user => {
      if (user) {
        // spara global presence-ref för Ove
        presenceRef = doc(db, "presence", "ove");
        if (presenceUnsub) presenceUnsub();
        presenceUnsub = onSnapshot(presenceRef, snap => {
          isOveActive = snap.exists() && snap.data().active;
          oveIndicator.textContent = isOveActive ? "Online" : "Offline";
          oveIndicator.classList.toggle("online", isOveActive);
          oveIndicator.classList.toggle("offline", !isOveActive);
        });

        authUI.classList.add("hidden");
        chatUI.classList.remove("hidden");
        userNameEl.textContent = user.displayName || user.email;

        // prenumerera på alla meddelanden
        const msgsQ = query(collection(db, "messages"), orderBy("timestamp"));
        if (chatUnsub) chatUnsub();
        chatUnsub = onSnapshot(msgsQ, snap => {
          chatWindow.textContent = "";
          snap.forEach(d => appendMessage(d.data().role, d.data().content));
        });

      } else {
        if (chatUnsub)     chatUnsub();
        if (presenceUnsub) presenceUnsub();
        authUI.classList.remove("hidden");
        chatUI.classList.add("hidden");
      }
    });

    // --- Skicka meddelande ---
    sendBtn.addEventListener("click", async () => {
      const text = messageIn.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return alert("Du måste vara inloggad!");

      // Om meddelandet innehåller "ove" → sätt Ove online
      if (text.toLowerCase().includes("ove") && presenceRef) {
        await setDoc(presenceRef, { active: true, timestamp: serverTimestamp() });
      }

      // spara användarens meddelande
      await addDoc(collection(db, "messages"), {
        role:      "user",
        content:   text,
        userId:    user.uid,
        timestamp: serverTimestamp()
      });

      // om Ove är online → anropa API och spara svaret
      if (isOveActive) {
        const res  = await fetch("/api/anthropic", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, history: [] })
        });
        const data = await res.json();
        await addDoc(collection(db, "messages"), {
          role:      "assistant",
          content:   data.reply,
          timestamp: serverTimestamp()
        });
        // sätt offline om Ove säger hejdå/tröttnat
        const r = data.reply.toLowerCase();
        if ( (r.includes("hejdå") || r.includes("tröttnat")) && presenceRef ) {
          await setDoc(presenceRef, { active: false, timestamp: serverTimestamp() });
        }
      }

      messageIn.value = "";
    });
  </script>
</body>
</html>

